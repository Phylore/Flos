{% extends "base.html" %}
{% block content %}
<div class="container py-3" style="max-width: 600px;">
  <h2 class="mb-4 text-center">üîç Ger√§t erfassen</h2>

  <!-- QR-Code-Scanformular -->
  <form method="GET" action="{{ url_for('geraete.geraet_neu') }}" id="scanform" autocomplete="off">
    <div class="mb-3">
      <label for="qrcode" class="form-label">QR-Code:</label>
      <input type="text" class="form-control form-control-lg" id="qrcode" name="qr_code" placeholder="QR-Code eingeben oder scannen" required autofocus>
    </div>
    <div class="d-grid mb-3">
      <button type="submit" class="btn btn-primary btn-lg">üì∑ Scannen</button>
    </div>
  </form>

  <!-- Direkt unter dem QR-Scanner: Neues Modell anlegen -->
  <div class="d-grid mb-4">
    <a href="{{ url_for('geraete.modell_neu_wizard', qrcode=qr_code) }}" class="btn btn-outline-success btn-lg">
      ‚ûï Neues Modell anlegen
    </a>
  </div>

  {% if qr_code %}
    <hr>
    <h3 class="mb-3">Ger√§t nicht gefunden ‚Äì bitte anlegen:</h3>

    <!-- Formular A: Bestehendes Modell ausw√§hlen -->
    <form action="{{ url_for('geraete.geraet_anlegen') }}" method="POST" autocomplete="off">
      <input type="hidden" name="qrcode" value="{{ qr_code }}">
      <div class="mb-2"><strong>QR-Code:</strong> {{ qr_code }}</div>

      <!-- Hersteller -->
      <div class="mb-3">
        <label for="hersteller" class="form-label">Hersteller:</label>
        <select id="hersteller" name="hersteller" class="form-select form-select-lg" required>
          <option value="">Hersteller w√§hlen</option>
          {% for h in hersteller %}
            <option value="{{ h.id }}">{{ h.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Kategorie -->
      <div class="mb-3">
        <label for="kategorie" class="form-label">Kategorie:</label>
        <select id="kategorie" name="kategorie" class="form-select form-select-lg" required>
          <option value="">Kategorie w√§hlen</option>
          {% for k in kategorien %}
            <option value="{{ k.id }}">{{ k.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Unterkategorie -->
      <div class="mb-3">
        <label for="unterkategorie" class="form-label">Unterkategorie:</label>
        <select id="unterkategorie" name="unterkategorie" class="form-select form-select-lg" required>
          <option value="">Unterkategorie w√§hlen</option>
          {% for uk in unterkategorien %}
            <option value="{{ uk.id }}" data-kategorie="{{ uk.kategorie_id }}">{{ uk.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Modell Dropdown -->
      <div class="mb-3">
        <label for="modell" class="form-label">Modell:</label>
        <select id="modell" name="modell" class="form-select form-select-lg" required>
          <option value="">Modell w√§hlen</option>
          {% for m in modelle %}
            <option value="{{ m.id }}">{{ m.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="d-grid">
        <button type="submit" name="aktion" value="bestehend" class="btn btn-success btn-lg">üíæ Ger√§t mit bestehendem Modell anlegen</button>
      </div>
    </form>
  {% endif %}
</div>

<!-- Kaskadierendes Dropdown f√ºr Unterkategorien -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  var katSelect = document.getElementById("kategorie");
  var ukSelect = document.getElementById("unterkategorie");
  function updateUnterkategorien() {
    var katId = katSelect.value;
    for (var i = 0; i < ukSelect.options.length; i++) {
      var option = ukSelect.options[i];
      if(option.value === "") {
        option.style.display = "";
        continue;
      }
      option.style.display = (option.getAttribute("data-kategorie") == katId) ? "" : "none";
    }
    // Erste passende Unterkategorie selektieren
    for (var i = 0; i < ukSelect.options.length; i++) {
      var option = ukSelect.options[i];
      if(option.style.display === "" && option.value !== "") {
        ukSelect.selectedIndex = i;
        break;
      }
    }
  }
  katSelect.addEventListener("change", updateUnterkategorien);
  updateUnterkategorien();
});
</script>
{% endblock %}

