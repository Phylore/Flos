{% extends "base.html" %}
{% block content %}
<div class="container py-3" style="max-width: 600px;">
  <h2 class="mb-4 text-center">üîç Ger√§t erfassen</h2>

  <!-- QR-Code-Scanformular -->
  <form method="GET" action="{{ url_for('geraete.geraet_neu') }}" id="scanform" autocomplete="off">
    <div class="mb-3">
      <label for="qrcode" class="form-label">QR-Code:</label>
      <input type="text" class="form-control form-control-lg" id="qrcode" name="qr_code" placeholder="QR-Code eingeben oder scannen" required autofocus>
    </div>
    <div class="d-grid">
      <button type="submit" class="btn btn-primary btn-lg">üì∑ Scannen</button>
    </div>
  </form>

  {% if qr_code %}
    <hr>
    <h3 class="mb-3">Ger√§t nicht gefunden ‚Äì bitte anlegen:</h3>

    <!-- Formular A: Bestehendes Modell ausw√§hlen -->
    <form action="{{ url_for('geraete.geraet_anlegen') }}" method="POST" autocomplete="off">
      <input type="hidden" name="qrcode" value="{{ qr_code }}">
      <div class="mb-2"><strong>QR-Code:</strong> {{ qr_code }}</div>

      <!-- Hersteller -->
      <div class="mb-3">
        <label for="hersteller" class="form-label">Hersteller:</label>
        <select id="hersteller" name="hersteller" class="form-select form-select-lg" required>
          <option value="">Hersteller w√§hlen</option>
          {% for h in hersteller %}
            <option value="{{ h.id }}">{{ h.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Kategorie -->
      <div class="mb-3">
        <label for="kategorie" class="form-label">Kategorie:</label>
        <select id="kategorie" name="kategorie" class="form-select form-select-lg" required disabled>
          <option value="">Kategorie w√§hlen</option>
        </select>
      </div>

      <!-- Unterkategorie -->
      <div class="mb-3">
        <label for="unterkategorie" class="form-label">Unterkategorie:</label>
        <select id="unterkategorie" name="unterkategorie" class="form-select form-select-lg" required disabled>
          <option value="">Unterkategorie w√§hlen</option>
        </select>
      </div>

      <!-- Modell Dropdown -->
      <div class="mb-3">
        <label for="modell" class="form-label">Modell:</label>
        <select id="modell" name="modell" class="form-select form-select-lg" required>
          <option value="">Modell w√§hlen</option>
          {% for m in modelle %}
            <option value="{{ m.id }}">{{ m.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="d-grid">
        <button type="submit" name="aktion" value="bestehend" class="btn btn-success btn-lg">üíæ Ger√§t mit bestehendem Modell anlegen</button>
      </div>
    </form>

    <hr class="my-4">

    <!-- Formular B: Neues Modell anlegen / √Ñhnliche anzeigen -->
    <form method="POST" action="{{ url_for('geraete.geraet_anlegen') }}" autocomplete="off">
      <input type="hidden" name="qrcode" value="{{ qr_code }}">
      <div class="mb-3">
        <label for="neues_modell" class="form-label">Neues Modell eingeben:</label>
        <input type="text" id="neues_modell" name="neues_modell" class="form-control form-control-lg" placeholder="Modellbezeichnung eingeben" required>
      </div>

      <!-- AJAX-Button & Dropdown NUR HIER! -->
      <div class="mb-3">
        <button type="button" class="btn btn-secondary" onclick="fetchAehnlicheModelle()">√Ñhnliche Modelle anzeigen</button>
        <select id="aehnliche_modelle_dropdown" class="form-select mt-2" style="display:none;"></select>
      </div>

      <div class="d-grid gap-2">
        <button type="submit" name="aktion" value="neuanlage" class="btn btn-outline-success btn-lg">‚ûï Neues Modell anlegen</button>
      </div>
    </form>

  {% endif %}
</div>

<!-- Dynamisches Dropdown-Skript f√ºr Hersteller, Kategorie, Unterkategorie, Modell -->
<script>
const formA = document.querySelector('form[action$="/geraet"]');
if (formA) {
  const hersteller = formA.querySelector("#hersteller");
  const kategorie = formA.querySelector("#kategorie");
  const unterkategorie = formA.querySelector("#unterkategorie");
  const modell = formA.querySelector("#modell");

  hersteller.addEventListener("change", function () {
    const herstellerId = this.value;
    fetch(`/geraete/api/kategorien?hersteller_id=${herstellerId}`)
      .then(res => res.json())
      .then(data => {
        kategorie.innerHTML = '<option value="">Kategorie w√§hlen</option>';
        data.forEach(k => {
          kategorie.innerHTML += `<option value="${k.id}">${k.name}</option>`;
        });
        kategorie.disabled = false;

        unterkategorie.innerHTML = '<option value="">Unterkategorie w√§hlen</option>';
        unterkategorie.disabled = true;
        modell.innerHTML = '<option value="">Modell w√§hlen</option>';
        modell.disabled = true;
      });
  });

  kategorie.addEventListener("change", function () {
    const kategorieId = this.value;
    fetch(`/geraete/api/unterkategorien?kategorie_id=${kategorieId}`)
      .then(res => res.json())
      .then(data => {
        unterkategorie.innerHTML = '<option value="">Unterkategorie w√§hlen</option>';
        data.forEach(u => {
          unterkategorie.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });
        unterkategorie.disabled = false;
        modell.innerHTML = '<option value="">Modell w√§hlen</option>';
        modell.disabled = true;
      });
  });

  unterkategorie.addEventListener("change", function () {
    const herstellerId = hersteller.value;
    const kategorieId = kategorie.value;
    const unterkategorieId = this.value;

    fetch(`/geraete/api/modelle?hersteller_id=${herstellerId}&kategorie_id=${kategorieId}&unterkategorie_id=${unterkategorieId}`)
      .then(res => res.json())
      .then(data => {
        modell.innerHTML = '<option value="">Modell w√§hlen</option>';
        data.forEach(m => {
          modell.innerHTML += `<option value="${m.id}">${m.name}</option>`;
        });
        modell.disabled = false;
      });
  });
}

// √Ñhnliche Modelle: AJAX + Dropdown-Funktion
function fetchAehnlicheModelle() {
    const name = document.getElementById('neues_modell').value;
    fetch(`/geraete/api/aehnliche_modelle?name=${encodeURIComponent(name)}`)
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById('aehnliche_modelle_dropdown');
            dropdown.innerHTML = '';
            if (data.length === 0) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
                return;
            }
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (${item.score}%)`;
                dropdown.appendChild(option);
            });
            dropdown.style.display = 'block';
        });
}

// Wenn User Vorschlag aus Dropdown ausw√§hlt ‚Üí ins Input √ºbernehmen
document.addEventListener('DOMContentLoaded', function () {
    const dropdown = document.getElementById('aehnliche_modelle_dropdown');
    if (dropdown) {
        dropdown.addEventListener('change', function () {
            document.getElementById('neues_modell').value = this.value;
        });
    }
});
</script>
{% endblock %}

